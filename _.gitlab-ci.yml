workflow:
  rules:
    - if: $CI_COMMIT_TITLE =~ /-draft$/
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

variables:
  NPM_TOKEN: ${CI_JOB_TOKEN}

# Cache explained: https://stackoverflow.com/a/69744855
# global cache settings for all jobs
# Ensure compatibility with the install job
# goal: the install job loads the cache and
# all other jobs can only use it
cache:
  # most npm libraries will only have 1 entry for the base project deps
  - key: &global_cache_node_mods
      files:
        - package-lock.json
      prefix: "node_modules"
    paths:
      - node_modules/
    policy: pull # prevent subsequent jobs from modifying cache

install:
  stage: .pre
  cache:
    # store npm cache for all branches (stores download pkg.tar.gz's)
    # will not be necessary for any other job
    - key: ${CI_JOB_NAME}
      # must be inside $CI_PROJECT_DIR for gitlab-runner caching (#3)
      paths:
        - .npm/
      when: on_success
      policy: pull-push

    # Mimic &global_cache_node_mods config but override policy
    # to allow this job to update the cache at the end of the job
    # and only update if it was a successful job
    # NOTE: I would use yaml anchors here but overriding the policy
    # in a yaml list is not as easy as a dictionary entry (#5)
    - key:
        files:
          - package-lock.json
        prefix: "node_modules"
      paths:
        - node_modules/
        - .husky/
      when: on_success
      policy: pull-push
  tags:
    - node
  before_script:
    - npm config set -- //$CI_SERVER_HOST/api/v4/packages/npm/:_authToken=$CI_JOB_TOKEN
    - npm config set @os3:registry https://$CI_SERVER_HOST/api/v4/packages/npm/
  script:
    - npm ci --cache .npm --ignore-scripts --prefer-offline

lint:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  tags:
    - node
  script: npm run lint

release:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  tags:
    - node
  before_script:
    - echo "@os3:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/">.npmrc
    - echo "//${CI_SERVER_HOST}/api/v4/packages/npm/:_authToken=${CI_JOB_TOKEN}">>.npmrc
    - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}">>.npmrc
    - echo "Created the following .npmrc:"; cat .npmrc
  script:
    - npm run release
